---
title: "R codes for Fertility manuscript"
author: "Meizhen"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    highlight: tango
    df_print: paged
    fig_caption: yes
    fig_height: 7
    fig_width: 10
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    self_contained: yes
    code_folding: hide
    toc_depth: 6
  pdf_document:
    toc: yes
    toc_depth: '6'
header-includes: \usepackage{multirow}
---

  <script language="javascript"> 
    function toggle(num) {
      var ele = document.getElementById("toggleText" + num);
      var text = document.getElementById("displayText" + num);
      if(ele.style.display == "block") {
        ele.style.display = "none";
        text.innerHTML = "show";
      }
      else {
        ele.style.display = "block";
        text.innerHTML = "hide";
      }
   } 
  </script>

<style>
pre {
  white-space: pre !important;
  overflow-x: scroll !important;  
  overflow-y: scroll !important;
  height: auto !important;
  max-height: 80vh !important;
}
</style>
```{r setup, include=FALSE}
options(digits = 4)
knitr::opts_chunk$set(echo = TRUE,tidy=TRUE,cache=F,warning = FALSE)
options(qwraps2_markup = "markdown")

```


```{r,message=FALSE,warning=FALSE,include=FALSE}
library(clubSandwich)
library(parameters)
library(sjstats)
library(rms)
library(survminer)
library(survival)
library(broom)
library("data.table")   
library(gtsummary)
library(gt)
library(tidyverse)
library(ggpubr)
library(cowplot)
library(gridExtra)
library(readxl)
library(sandwich)
library(boot)
library(table1)
library(flextable)
library(plyr)
library(Rcpp)
library(modelr)
library(readr)
library(gWQS)
library(broom.mixed)
library(yaml)
library(rmarkdown)
library(officer)
library(scales)
library(spatstat)
library(survey)
library(devtools)
library(cobalt)
# install_version("optmatch", version = "0.9.17", repos = "http://cran.us.r-project.org")
# install_github("markmfredrickson/RItools")
library(RItools)
library(optmatch)
library(mice)
#-------------------------------------------------------import data set
whole_cohort<-  read_excel("~/Projects/S-PRESTO/input/fertility/spresto_data_20230104.xlsx", sheet="Data")


#-------------------------------------------------------change variable format

### demographic factors ### 
#### Analysis Batch
whole_cohort$Analysis_Batch_recat<- factor(whole_cohort$Analysis_Batch_recat,
                                     levels = c("B6","B2","B3","B4","B5"))




#### ethnicity categorization
whole_cohort$ethnicity_specified_recat<- factor(whole_cohort$ethnicity_specified_recat,
                                           levels=c("Chinese","Malay","Indian"))


#### highest education                            
whole_cohort$pcv1_highest_education_completed_recat<- factor(whole_cohort$pcv1_highest_education_completed_recat,
                                           levels=c("University","Primary/Secondary/Post_secondary"))



#### parity status
whole_cohort$pcv1_parity_recat<- factor(whole_cohort$pcv1_parity_recat,
                                  levels=c("0",">= 1"))




label(whole_cohort$Analysis_Batch_recat)<- "Analysis Batch"
label(whole_cohort$ttp_pregnant_ref)<- "Pregnant"
label(whole_cohort$live_birth_recat)<- "Live birth"
label(whole_cohort$ttp_in_cycle1)<- "Time to pregnant (in menstrual cycle)"
label(whole_cohort$age_at_recruitment)<- "Age at Recruitment (year)"
label(whole_cohort$ethnicity_specified_recat)<- "Ethnicity"
label(whole_cohort$pcv1_highest_education_completed_recat)<- "Highest Education Completed at preconception one visit"
label(whole_cohort$pcv1_parity_recat)<- "Parity"
label(whole_cohort$pcv1_smoker)<- "Smoking status"
label(whole_cohort$PFHxS)<- "Log2(PFHxS(ng/ml))"
label(whole_cohort$PFHpA_bi_num)<- "PFHpA (LOD)"
label(whole_cohort$PFDA_bi_num)<- "PFDA (LOD)"
label(whole_cohort$PFHpS_bi_num)<- "PFHpS (LOD)"
label(whole_cohort$PFOS_Total)<- "Log2(PFOS_Total(ng/ml))"
label(whole_cohort$PFOA_Linear)<- "Log2(PFOA_Linear(ng/ml))"
label(whole_cohort$PFNA)<- "Log2(PFNA(ng/ml))"
label(whole_cohort$PFHxS_quar_num)<- "Quartile PFHxS"
label(whole_cohort$PFHpA_quar_num)<- "Quartile PFHpA"
label(whole_cohort$PFDA_quar_num)<- "Quartile PFDA"
label(whole_cohort$PFHpS_quar_num)<- "Quartile PFHpS"
label(whole_cohort$PFOS_Total_quar_num)<- "Quartile PFOS_Total"
label(whole_cohort$PFOA_Linear_quar_num)<- "Quartile PFOA_Linear"
label(whole_cohort$PFNA_quar_num)<- "Quartile PFNA"


#-------------------------------------------------------2. only include blood sample
blood<- whole_cohort %>% 
        filter(participation==1 & is.na(ttp_pregnant_ref)==FALSE)


```

```{r,message=FALSE,warning=FALSE}
demo_table <- blood %>%
    select(participation, ttp_pregnant_ref, age_at_recruitment, pcv1_highest_education_completed_recat,ethnicity_specified_recat, pcv1_parity_recat, pcv1_smoker, PFHxS, PFHpA,
           PFOS_Total, PFOA_Linear, PFNA, PFDA, PFHpS, ttp_in_cycle1) %>%
    tbl_summary(type = list(c("PFHxS", "PFHpA", "PFOS_Total", "PFOA_Linear", "PFNA","PFDA", "PFHpS", "ttp_in_cycle1") ~ "continuous"), 
                by = ttp_pregnant_ref,
                missing_text = "Missing", 
                digits = everything() ~ 2
                ) %>%
    bold_labels() %>%
    add_p(test = list(all_categorical() ~ "chisq.test",
          pcv1_smoker ~ "fisher.test"),
          pvalue_fun = function(x) style_pvalue(x, digits = 3)) %>%
    bold_p() %>%
    add_overall()

demo_table

```

# Table 1
```{r,message=FALSE,warning=FALSE}
demo_table <- blood %>%
    select(ttp_pregnant_ref, age_at_recruitment, pcv1_highest_education_completed_recat,ethnicity_specified_recat, pcv1_parity_recat, pcv1_smoker, PFHxS, PFHpA,
           PFOS_Total, PFOA_Linear, PFNA, PFDA, PFHpS, ttp_in_cycle1) %>%
    tbl_summary(type = list(c("PFHxS", "PFHpA", "PFOS_Total", "PFOA_Linear", "PFNA","PFDA", "PFHpS", "ttp_in_cycle1") ~ "continuous"), 
                by = ttp_pregnant_ref,
                missing_text = "Missing", 
                digits = everything() ~ 2
                ) %>%
    bold_labels() %>%
    add_p(test = list(all_categorical() ~ "chisq.test",
          pcv1_smoker ~ "fisher.test"),
          pvalue_fun = function(x) style_pvalue(x, digits = 3)) %>%
    bold_p() %>%
    add_overall()

demo_table

```



# Table 2
## Pregnant & Live birth (dichotomous outcomes)
```{r,warning=FALSE,message=FALSE}
####  remove missing values for sampling bias model
keeplist1=c("participation",'age_at_recruitment', 'pcv1_highest_education_completed_recat','ethnicity_specified_recat','pcv1_parity_recat')
whole_cohort_keep<- whole_cohort[,keeplist1]
whole_cohort_keep1<- whole_cohort[complete.cases(whole_cohort_keep),c(keeplist1, "ttp_pregnant_ref")]


# ipw for sampling bias
# Calculate weights
## 1. weights for sampling bias
### a. estimation of probability that the individual had blood measurement
ipw_part_sb_nomiss1 <- glm(participation ~ age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat, 
           family = binomial, data = whole_cohort_keep1)
pd_sb_nomiss<-  predict(ipw_part_sb_nomiss1, type = "response")

### b. estimation of numerator of ip weights
ipw_part_sb_nomiss2 <- glm(participation ~ 1,
           family = binomial, data = whole_cohort_keep1)
pn_sb_nomiss<-  predict(ipw_part_sb_nomiss2, type = "response")

### c. stabilized inverse of probability
whole_cohort_keep1$ipw_sb_nomiss <- ifelse(whole_cohort_keep1$participation == 0, ((1-pn_sb_nomiss)/(1-pd_sb_nomiss)),
                    (pn_sb_nomiss/pd_sb_nomiss))


blood$ipw_sb_nomiss<- (whole_cohort_keep1 %>% filter(participation==1 & is.na(ttp_pregnant_ref)==FALSE))$ipw_sb_nomiss
summary(blood$ipw_sb_nomiss)
```

### Individual PFAS - Logistics regression 
#### Pregnant
```{r, message=FALSE,warning=FALSE}

# library(writexl)
# blood_preg_lb<- blood %>%
#                select(ttp_pregnant_ref,live_birth_recat,PFHxS_quar_num,PFHpA_quar_num,PFOS_Total_quar_num,PFOA_Linear_quar_num,PFNA_quar_num,PFDA_quar_num,PFHpS_quar_num,Analysis_Batch_recat,age_at_recruitment, pcv1_highest_education_completed_recat,ethnicity_specified_recat,pcv1_parity_recat, ipw_sb_nomiss)
# 
# 
# write_xlsx(blood_preg_lb, "~/Projects/S-PRESTO/input/chemical & maternal/blood_preg_lb.xlsx")


## fit the model
PFAS_preg_adjusted_bm_1_matched_reg2<- glm(ttp_pregnant_ref ~ PFHxS_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss) 


PFAS_preg_adjusted_bm_2_matched_reg2<- glm(ttp_pregnant_ref ~PFHpA_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

PFAS_preg_adjusted_bm_3_matched_reg2<- glm(ttp_pregnant_ref ~PFOS_Total_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

PFAS_preg_adjusted_bm_4_matched_reg2<- glm(ttp_pregnant_ref ~PFOA_Linear_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

PFAS_preg_adjusted_bm_5_matched_reg2<- glm(ttp_pregnant_ref ~PFNA_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

PFAS_preg_adjusted_bm_6_matched_reg2<- glm(ttp_pregnant_ref ~PFDA_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

PFAS_preg_adjusted_bm_7_matched_reg2<- glm(ttp_pregnant_ref ~PFHpS_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

## extract the information from the model
PFAS_preg_adjusted_bm_1_matched_robust_reg2<- as_tibble(model_parameters(PFAS_preg_adjusted_bm_1_matched_reg2, ci_method="wald",vcov = "HC3" ,exponentiate = TRUE
))

PFAS_preg_adjusted_bm_2_matched_robust_reg2<- as_tibble(model_parameters(PFAS_preg_adjusted_bm_2_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))

PFAS_preg_adjusted_bm_3_matched_robust_reg2<- as_tibble(model_parameters(PFAS_preg_adjusted_bm_3_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))

PFAS_preg_adjusted_bm_4_matched_robust_reg2<- as_tibble(model_parameters(PFAS_preg_adjusted_bm_4_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))

PFAS_preg_adjusted_bm_5_matched_robust_reg2<- as_tibble(model_parameters(PFAS_preg_adjusted_bm_5_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))

PFAS_preg_adjusted_bm_6_matched_robust_reg2<- as_tibble(model_parameters(PFAS_preg_adjusted_bm_6_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))

PFAS_preg_adjusted_bm_7_matched_robust_reg2<- as_tibble(model_parameters(PFAS_preg_adjusted_bm_7_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))







PFAS_preg_adjusted_bm_matched_robust_reg2_estimate<- rbind(PFAS_preg_adjusted_bm_1_matched_robust_reg2[2,2],
                                                    PFAS_preg_adjusted_bm_2_matched_robust_reg2[2,2],
                                                    PFAS_preg_adjusted_bm_3_matched_robust_reg2[2,2],
                                                    PFAS_preg_adjusted_bm_4_matched_robust_reg2[2,2],
                                                    PFAS_preg_adjusted_bm_5_matched_robust_reg2[2,2],
                                                    PFAS_preg_adjusted_bm_6_matched_robust_reg2[2,2],
                                                    PFAS_preg_adjusted_bm_7_matched_robust_reg2[2,2])

PFAS_preg_adjusted_bm_matched_robust_reg2_sd<-rbind(PFAS_preg_adjusted_bm_1_matched_robust_reg2[2,3],
                                                    PFAS_preg_adjusted_bm_2_matched_robust_reg2[2,3],
                                                    PFAS_preg_adjusted_bm_3_matched_robust_reg2[2,3],
                                                    PFAS_preg_adjusted_bm_4_matched_robust_reg2[2,3],
                                                    PFAS_preg_adjusted_bm_5_matched_robust_reg2[2,3],
                                                    PFAS_preg_adjusted_bm_6_matched_robust_reg2[2,3],
                                                    PFAS_preg_adjusted_bm_7_matched_robust_reg2[2,3])

PFAS_preg_adjusted_bm_matched_robust_reg2_ci_low<-rbind(PFAS_preg_adjusted_bm_1_matched_robust_reg2[2,5],
                                                    PFAS_preg_adjusted_bm_2_matched_robust_reg2[2,5],
                                                    PFAS_preg_adjusted_bm_3_matched_robust_reg2[2,5],
                                                    PFAS_preg_adjusted_bm_4_matched_robust_reg2[2,5],
                                                    PFAS_preg_adjusted_bm_5_matched_robust_reg2[2,5],
                                                    PFAS_preg_adjusted_bm_6_matched_robust_reg2[2,5],
                                                    PFAS_preg_adjusted_bm_7_matched_robust_reg2[2,5])

PFAS_preg_adjusted_bm_matched_robust_reg2_ci_high<-rbind(PFAS_preg_adjusted_bm_1_matched_robust_reg2[2,6],
                                                    PFAS_preg_adjusted_bm_2_matched_robust_reg2[2,6],
                                                    PFAS_preg_adjusted_bm_3_matched_robust_reg2[2,6],
                                                    PFAS_preg_adjusted_bm_4_matched_robust_reg2[2,6],
                                                    PFAS_preg_adjusted_bm_5_matched_robust_reg2[2,6],
                                                    PFAS_preg_adjusted_bm_6_matched_robust_reg2[2,6],
                                                    PFAS_preg_adjusted_bm_7_matched_robust_reg2[2,6])

PFAS_preg_adjusted_bm_matched_robust_reg2_p<-rbind(PFAS_preg_adjusted_bm_1_matched_robust_reg2[2,9],
                                                    PFAS_preg_adjusted_bm_2_matched_robust_reg2[2,9],
                                                    PFAS_preg_adjusted_bm_3_matched_robust_reg2[2,9],
                                                    PFAS_preg_adjusted_bm_4_matched_robust_reg2[2,9],
                                                    PFAS_preg_adjusted_bm_5_matched_robust_reg2[2,9],
                                                    PFAS_preg_adjusted_bm_6_matched_robust_reg2[2,9],
                                                    PFAS_preg_adjusted_bm_7_matched_robust_reg2[2,9])

PFAS_name<- c("PFHxS","PFHpA","PFOS_Total","PFOA_Linear","PFNA","PFDA","PFHpS")

PFAS_preg_adjusted_bm_matched_robust_reg2<- data.frame(PFAS_name,
           round(PFAS_preg_adjusted_bm_matched_robust_reg2_estimate,3),
           # round(PFAS_preg_adjusted_bm_matched_robust_reg2_sd,2),
           round(PFAS_preg_adjusted_bm_matched_robust_reg2_ci_low,3),
           round(PFAS_preg_adjusted_bm_matched_robust_reg2_ci_high,3),
           round(PFAS_preg_adjusted_bm_matched_robust_reg2_p,4))%>% 
unite(ci,CI_low,CI_high,sep=",")


PFAS_preg_adjusted_bm_matched_robust_reg2_table1<- flextable(PFAS_preg_adjusted_bm_matched_robust_reg2)  %>% 
                 set_header_labels(Coefficient="OR",ci="95% CI",p="p.value") %>% 
                 add_footer_lines(values=c("p.value less than 0.05 is marked in red","Adjusted model: adjusted for Batch effect, age at recruitment, Highest education status, ethinicity, and parity at pcv1 visit"))%>% 
                 color( ~p<0.05,~p,color="red") %>% 
                 theme_box 


PFAS_preg_adjusted_bm_matched_robust_reg2_table1


```


#### Live birth
```{r, message=FALSE,warning=FALSE}


## fit the model
PFAS_lb_adjusted_bm_1_matched_reg2<- glm(live_birth_recat ~ PFHxS_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss) 


PFAS_lb_adjusted_bm_2_matched_reg2<- glm(live_birth_recat ~PFHpA_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

PFAS_lb_adjusted_bm_3_matched_reg2<- glm(live_birth_recat ~PFOS_Total_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

PFAS_lb_adjusted_bm_4_matched_reg2<- glm(live_birth_recat ~PFOA_Linear_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

PFAS_lb_adjusted_bm_5_matched_reg2<- glm(live_birth_recat ~PFNA_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

PFAS_lb_adjusted_bm_6_matched_reg2<- glm(live_birth_recat ~PFDA_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

PFAS_lb_adjusted_bm_7_matched_reg2<- glm(live_birth_recat ~PFHpS_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,data=blood, family='binomial',weights = blood$ipw_sb_nomiss)

## extract the information from the model
PFAS_lb_adjusted_bm_1_matched_robust_reg2<- as_tibble(model_parameters(PFAS_lb_adjusted_bm_1_matched_reg2, ci_method="wald",vcov = "HC3" ,exponentiate = TRUE
))

PFAS_lb_adjusted_bm_2_matched_robust_reg2<- as_tibble(model_parameters(PFAS_lb_adjusted_bm_2_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))

PFAS_lb_adjusted_bm_3_matched_robust_reg2<- as_tibble(model_parameters(PFAS_lb_adjusted_bm_3_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))

PFAS_lb_adjusted_bm_4_matched_robust_reg2<- as_tibble(model_parameters(PFAS_lb_adjusted_bm_4_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))

PFAS_lb_adjusted_bm_5_matched_robust_reg2<- as_tibble(model_parameters(PFAS_lb_adjusted_bm_5_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))

PFAS_lb_adjusted_bm_6_matched_robust_reg2<- as_tibble(model_parameters(PFAS_lb_adjusted_bm_6_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))

PFAS_lb_adjusted_bm_7_matched_robust_reg2<- as_tibble(model_parameters(PFAS_lb_adjusted_bm_7_matched_reg2, ci_method="wald", vcov = "HC3",exponentiate = TRUE
))




PFAS_lb_adjusted_bm_matched_robust_reg2_estimate<- rbind(PFAS_lb_adjusted_bm_1_matched_robust_reg2[2,2],
                                                    PFAS_lb_adjusted_bm_2_matched_robust_reg2[2,2],
                                                    PFAS_lb_adjusted_bm_3_matched_robust_reg2[2,2],
                                                    PFAS_lb_adjusted_bm_4_matched_robust_reg2[2,2],
                                                    PFAS_lb_adjusted_bm_5_matched_robust_reg2[2,2],
                                                    PFAS_lb_adjusted_bm_6_matched_robust_reg2[2,2],
                                                    PFAS_lb_adjusted_bm_7_matched_robust_reg2[2,2])

PFAS_lb_adjusted_bm_matched_robust_reg2_sd<-rbind(PFAS_lb_adjusted_bm_1_matched_robust_reg2[2,3],
                                                    PFAS_lb_adjusted_bm_2_matched_robust_reg2[2,3],
                                                    PFAS_lb_adjusted_bm_3_matched_robust_reg2[2,3],
                                                    PFAS_lb_adjusted_bm_4_matched_robust_reg2[2,3],
                                                    PFAS_lb_adjusted_bm_5_matched_robust_reg2[2,3],
                                                    PFAS_lb_adjusted_bm_6_matched_robust_reg2[2,3],
                                                    PFAS_lb_adjusted_bm_7_matched_robust_reg2[2,3])

PFAS_lb_adjusted_bm_matched_robust_reg2_ci_low<-rbind(PFAS_lb_adjusted_bm_1_matched_robust_reg2[2,5],
                                                    PFAS_lb_adjusted_bm_2_matched_robust_reg2[2,5],
                                                    PFAS_lb_adjusted_bm_3_matched_robust_reg2[2,5],
                                                    PFAS_lb_adjusted_bm_4_matched_robust_reg2[2,5],
                                                    PFAS_lb_adjusted_bm_5_matched_robust_reg2[2,5],
                                                    PFAS_lb_adjusted_bm_6_matched_robust_reg2[2,5],
                                                    PFAS_lb_adjusted_bm_7_matched_robust_reg2[2,5])

PFAS_lb_adjusted_bm_matched_robust_reg2_ci_high<-rbind(PFAS_lb_adjusted_bm_1_matched_robust_reg2[2,6],
                                                    PFAS_lb_adjusted_bm_2_matched_robust_reg2[2,6],
                                                    PFAS_lb_adjusted_bm_3_matched_robust_reg2[2,6],
                                                    PFAS_lb_adjusted_bm_4_matched_robust_reg2[2,6],
                                                    PFAS_lb_adjusted_bm_5_matched_robust_reg2[2,6],
                                                    PFAS_lb_adjusted_bm_6_matched_robust_reg2[2,6],
                                                    PFAS_lb_adjusted_bm_7_matched_robust_reg2[2,6])

PFAS_lb_adjusted_bm_matched_robust_reg2_p<-rbind(PFAS_lb_adjusted_bm_1_matched_robust_reg2[2,9],
                                                    PFAS_lb_adjusted_bm_2_matched_robust_reg2[2,9],
                                                    PFAS_lb_adjusted_bm_3_matched_robust_reg2[2,9],
                                                    PFAS_lb_adjusted_bm_4_matched_robust_reg2[2,9],
                                                    PFAS_lb_adjusted_bm_5_matched_robust_reg2[2,9],
                                                    PFAS_lb_adjusted_bm_6_matched_robust_reg2[2,9],
                                                    PFAS_lb_adjusted_bm_7_matched_robust_reg2[2,9])

PFAS_name<- c("PFHxS","PFHpA","PFOS_Total","PFOA_Linear","PFNA","PFDA","PFHpS")

PFAS_lb_adjusted_bm_matched_robust_reg2<- data.frame(PFAS_name,
           round(PFAS_lb_adjusted_bm_matched_robust_reg2_estimate,3),
           # round(PFAS_lb_adjusted_bm_matched_robust_reg2_sd,3),
           round(PFAS_lb_adjusted_bm_matched_robust_reg2_ci_low,3),
           round(PFAS_lb_adjusted_bm_matched_robust_reg2_ci_high,3),
           round(PFAS_lb_adjusted_bm_matched_robust_reg2_p,4))%>% 
unite(ci,CI_low,CI_high,sep=",")


PFAS_lb_adjusted_bm_matched_robust_reg2_table<- flextable(PFAS_lb_adjusted_bm_matched_robust_reg2)%>% 
                 set_header_labels(Coefficient="OR",ci="95% CI",p="p.value") %>% 
                 add_footer_lines(values=c("p.value less than 0.05 is marked in red","Adjusted model: adjusted for Batch effect, age at recruitment, Highest education status, ethinicity, and parity at pcv1 visit"))%>% 
                 color( ~p<0.05,~p,color="red") %>% 
                 theme_box 


PFAS_lb_adjusted_bm_matched_robust_reg2_table

```




### Joint effect of PFAS - BWQS models
####---------------------------- Pregnancy
Estimate (95% CI): 0.612 (0.367, 1.022)
 
 
Weights order: PFDA: 0.2439   PFOA_Linear: 0.1552  PFOS_Total: 0.1533  PFHpA: 0.1269  PFHpS: 0.1142  PFHxS: 0.1032   PFNA: 0.1032   

####---------------------------- Live birth
Estimate (95% CI): 0.664 (0.402, 1.066)
 
 
Weights order: PFDA: 0.2077   PFOS_Total: 0.1607  PFOA_Linear: 0.1516  PFHpA: 0.1372  PFHpS: 0.1218  PFHxS: 0.1112   PFNA: 0.1099   





## TTP - observed cycles (time to event outcome)
### Individual PFAS - Cox regression
```{r,warning=FALSE,message=FALSE}
blood_ttpnomiss<- blood %>% 
                  filter(is.na(ttp_in_cycle1)==FALSE & is.na(status)==FALSE)

# str(blood)
# blood_ttpnomiss$miss<- rep(1,376)
# blood<- blood %>% 
#         left_join(blood_ttpnomiss[,c("Subject_ID","miss")], by="Subject_ID") 
# blood$participation<- ifelse(is.na(blood$miss)==TRUE, 0, 1)
# 
# 
# library(writexl)
# blood_vishal<- blood_ttpnomiss %>%
#                select(ttp_pregnant_ref,live_birth_recat,ttp_in_cycle1,status,PFHxS_quar_num,PFHpA_quar_num,PFOS_Total_quar_num,PFOA_Linear_quar_num,PFNA_quar_num,PFDA_quar_num,PFHpS_quar_num,Analysis_Batch_recat,age_at_recruitment, pcv1_highest_education_completed_recat,ethnicity_specified_recat,pcv1_parity_recat, ipw_sb_nomiss)
# 
# 
# write_xlsx(blood_vishal, "~/Projects/S-PRESTO/input/chemical & maternal/blood_survival.xlsx")


## adjusted 
### model fit
surv_model_adjusted1<- coxph(Surv(ttp_in_cycle1,status) ~ PFHxS_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,
                         blood_ttpnomiss, weights= blood_ttpnomiss$ipw_sb_nomiss,robust=TRUE) 

surv_model_adjusted2<- coxph(Surv(ttp_in_cycle1,status) ~ PFHpA_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,
                         blood_ttpnomiss, weights= blood_ttpnomiss$ipw_sb_nomiss,robust=TRUE) 

surv_model_adjusted3<- coxph(Surv(ttp_in_cycle1,status) ~ PFOS_Total_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,
                         blood_ttpnomiss, weights= blood_ttpnomiss$ipw_sb_nomiss,robust=TRUE) 

surv_model_adjusted4<- coxph(Surv(ttp_in_cycle1,status) ~ PFOA_Linear_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,
                         blood_ttpnomiss, weights= blood_ttpnomiss$ipw_sb_nomiss,robust=TRUE) 

surv_model_adjusted5<- coxph(Surv(ttp_in_cycle1,status) ~ PFNA_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,
                         blood_ttpnomiss, weights= blood_ttpnomiss$ipw_sb_nomiss,robust=TRUE) 

surv_model_adjusted6<- coxph(Surv(ttp_in_cycle1,status) ~ PFDA_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,
                         blood_ttpnomiss, weights= blood_ttpnomiss$ipw_sb_nomiss,robust=TRUE) 

surv_model_adjusted7<- coxph(Surv(ttp_in_cycle1,status) ~ PFHpS_quar_num+Analysis_Batch_recat+age_at_recruitment+ pcv1_highest_education_completed_recat+ethnicity_specified_recat+pcv1_parity_recat,
                         blood_ttpnomiss, weights= blood_ttpnomiss$ipw_sb_nomiss,robust=TRUE) 

 
### test proportional hazard assumption
test_ph_assum1<- cox.zph(surv_model_adjusted1)
test_ph_assum2<- cox.zph(surv_model_adjusted2)
test_ph_assum3<- cox.zph(surv_model_adjusted3)
test_ph_assum4<- cox.zph(surv_model_adjusted4)
test_ph_assum5<- cox.zph(surv_model_adjusted5)
test_ph_assum6<- cox.zph(surv_model_adjusted6)
test_ph_assum7<- cox.zph(surv_model_adjusted7)

test_ph_assum1
test_ph_assum2
test_ph_assum3
test_ph_assum4
test_ph_assum5
test_ph_assum6
test_ph_assum7

### summarize models into table
surv_model_adjusted1_table<- surv_model_adjusted1 %>%
                               tbl_regression(exponentiate = TRUE,
                               include = PFHxS_quar_num,
                               show_single_row=PFHxS_quar_num,
                               pvalue_fun = function(x) style_pvalue(x, digits = 3),
                               estimate_fun = function(x) style_sigfig(x, digits = 3)) 

surv_model_adjusted2_table<- surv_model_adjusted2 %>%
                               tbl_regression(exponentiate = TRUE,
                               include = PFHpA_quar_num,
                               show_single_row=PFHpA_quar_num,
                               pvalue_fun = function(x) style_pvalue(x, digits = 3),
                               estimate_fun = function(x) style_sigfig(x, digits = 3)) 

surv_model_adjusted3_table<- surv_model_adjusted3 %>%
                               tbl_regression(exponentiate = TRUE,
                               include = PFOS_Total_quar_num,
                               show_single_row=PFOS_Total_quar_num,
                               pvalue_fun = function(x) style_pvalue(x, digits = 3),
                               estimate_fun = function(x) style_sigfig(x, digits = 3)) 

surv_model_adjusted4_table<- surv_model_adjusted4 %>%
                               tbl_regression(exponentiate = TRUE,
                               include = PFOA_Linear_quar_num,
                               show_single_row=PFOA_Linear_quar_num,
                               pvalue_fun = function(x) style_pvalue(x, digits = 3),
                               estimate_fun = function(x) style_sigfig(x, digits = 3)) 

surv_model_adjusted5_table<- surv_model_adjusted5 %>%
                               tbl_regression(exponentiate = TRUE,
                               include = PFNA_quar_num,
                               show_single_row=PFNA_quar_num,
                               pvalue_fun = function(x) style_pvalue(x, digits = 3),
                               estimate_fun = function(x) style_sigfig(x, digits = 3)) 

surv_model_adjusted6_table<- surv_model_adjusted6 %>%
                               tbl_regression(exponentiate = TRUE,
                               include = PFDA_quar_num,
                               show_single_row=PFDA_quar_num,
                               pvalue_fun = function(x) style_pvalue(x, digits = 3),
                               estimate_fun = function(x) style_sigfig(x, digits = 3)) 

surv_model_adjusted7_table<- surv_model_adjusted7 %>%
                               tbl_regression(exponentiate = TRUE,
                               include = PFHpS_quar_num,
                               show_single_row=PFHpS_quar_num,
                               pvalue_fun = function(x) style_pvalue(x, digits = 3),
                               estimate_fun = function(x) style_sigfig(x, digits = 3)) 
### combine tables
surv_model_adjusted_table<- tbl_stack(tbls = list(surv_model_adjusted1_table,surv_model_adjusted2_table,surv_model_adjusted3_table,surv_model_adjusted4_table,surv_model_adjusted5_table,surv_model_adjusted6_table,surv_model_adjusted7_table))%>%
                               modify_header(
                                   update = list(
                                   label ~ '**PFAS Variable**'))%>%
                               bold_p() %>%
                               bold_labels()%>% 
                               as_gt()%>% 
                                  tab_footnote(
                                    footnote=c("Adjusted model: adjusted for Batch effect, age at recruitment, Highest education status, ethinicity, and parity at pcv1 visit"),
                                    locations=  cells_stubhead()
                         )

surv_model_adjusted_table

```

### Joint effect of PFAS - BWQS for TTP
 
Estimate (95% CI): 0.890 (0.730, 1.024)
 
 
Weights order: PFDA: 0.1791   PFHpA: 0.1725   PFOS_Total: 0.1608   PFOA_Linear: 0.1321   PFHxS: 1248   PFNA: 0.1154   PFHpS: 0.1153



















