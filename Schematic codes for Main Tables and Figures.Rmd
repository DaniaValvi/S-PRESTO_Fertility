---
title: "R codes for Fertility manuscript"
author: "Meizhen Yao"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    highlight: tango
    df_print: paged
    fig_caption: yes
    fig_height: 7
    fig_width: 10
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    self_contained: yes
    code_folding: hide
    toc_depth: 6
header-includes: \usepackage{multirow}
---

<style type="text/css">
body{
  /*font-family: Helvetica;*/
  font-size: 12pt;
}
</style>


```{r setup, include=FALSE}
options(digits = 4)
knitr::opts_chunk$set(echo = TRUE,tidy=TRUE,cache=F,warning = FALSE)
# suppress warning messages for final rendering
old.warn <- getOption("warn")
options(qwraps2_markup = "markdown")

```


```{r,message=FALSE,warning=FALSE,include=FALSE}
library(clubSandwich)
library(parameters)
library(sjstats)
library(rms)
library(survminer)
library(survival)
library(broom)
library("data.table")   
library(gtsummary)
library(gt)
library(tidyverse)
library(ggpubr)
library(cowplot)
library(gridExtra)
library(readxl)
library(sandwich)
library(boot)
library(table1)
library(flextable)
library(plyr)
library(Rcpp)
library(modelr)
library(readr)
library(gWQS)
library(broom.mixed)
library(yaml)
library(rmarkdown)
library(officer)
library(scales)
library(spatstat)
library(survey)
library(devtools)
library(cobalt)
# install_version("optmatch", version = "0.9.17", repos = "http://cran.us.r-project.org")
# install_github("markmfredrickson/RItools")
library(RItools)
library(optmatch)
library(mice)
#-------------------------------------------------------import data set
whole_cohort<-  read_excel("~/Projects/S-PRESTO/input/fertility/spresto_data_20230104.xlsx", sheet="Data")


#-------------------------------------------------------change variable format

### demographic factors ### 
#### Analysis Batch
whole_cohort$Analysis_Batch_recat<- factor(whole_cohort$Analysis_Batch_recat,
                                     levels = c("B6","B2","B3","B4","B5"))

#### ethnicity categorization
whole_cohort$ethnicity_specified_recat<- factor(whole_cohort$ethnicity_specified_recat,
                                           levels=c("Chinese","Malay","Indian"))

#### highest education                            
whole_cohort$pcv1_highest_education_completed_recat<- factor(whole_cohort$pcv1_highest_education_completed_recat,                                         levels=c("University","Primary/Secondary/Post_secondary"))


#### parity status
whole_cohort$pcv1_parity_recat<- factor(whole_cohort$pcv1_parity_recat,
                                  levels=c("0",">= 1"))

label(whole_cohort$Analysis_Batch_recat)<- "Analysis Batch"
label(whole_cohort$ttp_pregnant_ref)<- "Pregnant"
label(whole_cohort$live_birth_recat)<- "Live birth"
label(whole_cohort$ttp_in_cycle1)<- "Time to pregnant (in menstrual cycle)"
label(whole_cohort$age_at_recruitment)<- "Age at Recruitment (year)"
label(whole_cohort$ethnicity_specified_recat)<- "Ethnicity"
label(whole_cohort$pcv1_highest_education_completed_recat)<- "Highest Education Completed at preconception one visit"
label(whole_cohort$pcv1_parity_recat)<- "Parity"
label(whole_cohort$pcv1_smoker)<- "Smoking status"
label(whole_cohort$PFHxS)<- "Log2(PFHxS(ng/ml))"
label(whole_cohort$PFHpA_bi_num)<- "PFHpA (LOD)"
label(whole_cohort$PFDA_bi_num)<- "PFDA (LOD)"
label(whole_cohort$PFHpS_bi_num)<- "PFHpS (LOD)"
label(whole_cohort$PFOS_Total)<- "Log2(PFOS_Total(ng/ml))"
label(whole_cohort$PFOA_Linear)<- "Log2(PFOA_Linear(ng/ml))"
label(whole_cohort$PFNA)<- "Log2(PFNA(ng/ml))"
label(whole_cohort$PFHxS_quar_num)<- "Quartile PFHxS"
label(whole_cohort$PFHpA_quar_num)<- "Quartile PFHpA"
label(whole_cohort$PFDA_quar_num)<- "Quartile PFDA"
label(whole_cohort$PFHpS_quar_num)<- "Quartile PFHpS"
label(whole_cohort$PFOS_Total_quar_num)<- "Quartile PFOS_Total"
label(whole_cohort$PFOA_Linear_quar_num)<- "Quartile PFOA_Linear"
label(whole_cohort$PFNA_quar_num)<- "Quartile PFNA"


#-------------------------------------------------------2. only include blood sample
blood<- whole_cohort %>% 
        filter(participation==1 & is.na(ttp_pregnant_ref)==FALSE)


```


# Table 1
```{r,message=FALSE,warning=FALSE}
demo_table <- blood %>%
    select(ttp_pregnant_ref, age_at_recruitment, pcv1_highest_education_completed_recat,ethnicity_specified_recat, pcv1_parity_recat, pcv1_smoker, PFHxS, PFHpA,
           PFOS_Total, PFOA_Linear, PFNA, PFDA, PFHpS, ttp_in_cycle1) %>%
    tbl_summary(type = list(c("PFHxS", "PFHpA", "PFOS_Total", "PFOA_Linear", "PFNA","PFDA", "PFHpS", "ttp_in_cycle1") ~ "continuous"), 
                by = ttp_pregnant_ref,
                missing_text = "Missing", 
                digits = everything() ~ 2
                ) %>%
    bold_labels() %>%
    add_p(test = list(all_categorical() ~ "chisq.test",
          pcv1_smoker ~ "fisher.test"),
          pvalue_fun = function(x) style_pvalue(x, digits = 3)) %>%
    bold_p() %>%
    add_overall()

demo_table

```

